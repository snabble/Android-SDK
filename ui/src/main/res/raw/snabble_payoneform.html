<!doctype html>
<html>
<head>
<title>Payone Credit Card Entry</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta charset="UTF-8">
<script type="text/javascript">
// intercept console.log
window.console.log = function(msg) {
    snabble.log(msg);
};

// intercept errors
window.onerror = (msg, url, line, column, error) => {
    const message = {
        message: msg,
        url: url,
        line: line,
        column: column,
        error: JSON.stringify(error)
    }

    console.log(message);
};

function showError(msg) {
    snabble.toast(msg)
    snabble.log(msg)
}

window.postMessage = function(a,b) {
    snabble.log(`${a}, ${b}`)
}

function processResponse(response) {
    snabble.log("processResponse for " + response.lastname)
    snabble.saveCard(
        response.pseudocardpan,
        response.truncatedcardpan,
        response.cardtype,
        response.cardexpiredate,
        response.lastname)
}
</script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/css/bootstrap.css">
<style type="text/css">
* { box-sizing: content-box; }
.container { width: auto; }
.header { margin-bottom: 1rem; }
label { font-weight: bold; }

.payone-input-mock {
    border: 2px solid #0077bb;
    border-radius: 10px;
    padding: 5px 15px;
    max-width: 100%;
}

.payone-input-mock iframe {
    height: 50px;
    width: 100%;
    vertical-align: middle;
}

.payone-input-mock input {
    height: 42px;
    width: 90%;
    vertical-align: middle;
    font-size: 17px;
    border: none;
    outline: none;
}

#submit { background-color: #0077bb; padding-left:0; padding-right: 0; width: 100%; }

input:focus {
  outline: none;
  box-shadow: none;
}
@media (prefers-color-scheme: dark) {
    html {
        background-color: #111;
        color: #eee;
    }
}
</style>
<script src="https://secure.pay1.de/client-api/js/v1/payone_hosted.js"></script>
<script type="text/javascript">
console.log("payone form start");
/**
 * The PAYONE auto card type detection class constructor.
 *
 * @param config The auto card type detection config.
 * @constructor
 */
function PayoneAutoCcDetection(config) {
    console.log("PayoneAutoCcDetection " + config)
    // Apply config defaults.
    this._config = config;

    // Setup auto credit card detection config.
    console.log("supported types: " + this._config.supportedCardTypes);
    this._config.hostedIframesConfig.config.autoCardtypeDetection = {
        deactivate: false,
        supportedCardtypes: this._config.supportedCardTypes,
        callback: this._handleDetectionResult.bind(this),
    };

    // Create hosted IFrames object.
    this._hostedIframe = new Payone.ClientApi.HostedIFrames(
        this._config.hostedIframesConfig.config,
        this._config.hostedIframesConfig.request
    );

    // Register credit card check callback.
    // The hosted IFrames API expects a callback provided as string,
    // therefore we cannot use a function value reference directly.
    // As a workaround we register the actual handler method as global
    // function with a random unique name which will be provided to the
    // hosted IFrames API later.
    this._creditCardCheckCallbackName = 'payone_cc_check_callback_' + Math.random().toString().substr(2);
    window[this._creditCardCheckCallbackName] = this._creditCardCheckCallback.bind(this);
}

/**
 * Handles automatically detected card types.
 * This is the handler that will be called by the hosted iFrames API
 * if a card type detection result is available.
 *
 * @param {string} type The detection result of the hosted IFrames API.
 * @private
 */
PayoneAutoCcDetection.prototype._handleDetectionResult = function (type) {
    console.log("handleDetection " + type);
    type = type.toUpperCase();

    // Delegate further processing to dedicated handlers.
    switch (type) {
        case '?':
            this._handleUnknownCardType(type);
            break;
        case '-':
            this._handleUnsupportedCardType(type);
            break;
        default:
            this._handleValidCardType(type);
            break;
    }
};

/**
 * Handles detection results of valid card types.
 *
 * @param {string} type The detected valid card type.
 * @private
 */
PayoneAutoCcDetection.prototype._handleValidCardType = function (type) {
    console.log("handleValidCard " + type);
    this._changeIcon(type);
};

/**
 * Handles unsupported card type detection results.
 *
 * @private
 */
PayoneAutoCcDetection.prototype._handleUnsupportedCardType = function () {
    console.log("handleUnsupportedType");
};

/**
 * Handles the credit card check result.
 *
 * @param {object} response The credit card check result from the hosted IFrame API.
 * @private
 */
PayoneAutoCcDetection.prototype._creditCardCheckCallback = function (response) {
    console.log("checkCallback: " + JSON.stringify(response));
    switch (response.status) {
        case 'VALID':
            console.log('Success! Credit card check was valid.');
            var lastName = document.getElementById('lastName').value;
            processResponse({...response, lastName});
            break;
        case 'INVALID':
        case 'ERROR':
            showError('Error ' + response.errorcode + ': ' + response.errormessage);
            break;
        default:
            showError('API returned an unexpected status.');
            break;
    }
};

/**
 * Performs the credit card check.
 */
PayoneAutoCcDetection.prototype.performCreditCardCheck = function () {
    console.log("performCheck");
    var name = document.getElementById('lastName').value
    if (this._hostedIframe.isComplete() && name != "") {
        console.log("complete!");
        this._hostedIframe.creditCardCheck(this._creditCardCheckCallbackName);
    }
    else {
        console.log("incomplete :(");
        showError('{{incompleteForm}}');
    }
};

PayoneAutoCcDetection.prototype.setInitialCardType = function (type) {
    console.log("set initial card type " + type)
    this._hostedIframe.setCardType(type)
}
</script>
</head>
<body>
    <div class="container">
        <div class="row">
            <div class="col py-5">
                <!-- The form HTML with IFrame fields. -->
                <form id="cc-form" class="my-3" action="#" method="post">
                    <div class="form-group">
                        <label for="payone-cc-lastname">{{lastName}}</label>
                        <div class="payone-input-mock">
                            <input type="text" id="lastName"/>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="payone-cc-pan">{{cardNumberLabel}}</label>
                        <div class="payone-input-mock payone-input-mock--pan">
                            <!-- Mount element for PAN IFrame. -->
                            <span id="payone-cc-pan"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="payone-cc-cvc">{{cvcLabel}}</label>
                        <div class="payone-input-mock payone-input-mock--cvc">
                            <!-- Mount element for CVC IFrame. -->
                            <span id="payone-cc-cvc"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="payone-cc-expire-month">{{expireMonthLabel}}</label>
                        <div class="payone-input-mock payone-input-mock--expire-month">
                            <!-- Mount element for card expire month IFrame. -->
                            <span id="payone-cc-expire-month"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="payone-cc-expire-year">{{expireYearLabel}}</label>
                        <div class="payone-input-mock payone-input-mock--expire-year">
                            <!-- Mount element for card expire year IFrame. -->
                            <span id="payone-cc-expire-year"></span>
                        </div>
                    </div>

                    <div class="form-group mt-5">
                        <button id="submit" class="btn btn-primary btn-lg" type="button">{{saveButtonLabel}}</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

<script>
(function () {
    var autoCcDetection = new PayoneAutoCcDetection({
        supportedCardTypes: ["{{supportedCardType}}"],
        hostedIframesConfig: {
            config: {
                fields: {
                    cardpan: {
                        selector: "payone-cc-pan",
                        type: "number"
                    },
                    cardcvc2: {
                        selector: "payone-cc-cvc",
                        type: "password",
                        size: "4",
                        maxlength: "4",
                        length: { "V": 3, "M": 3, "A": 4 }
                    },
                    cardexpiremonth: {
                        selector: "payone-cc-expire-month",
                        type: "number",
                        size: "2",
                        maxlength: "2"
                    },
                    cardexpireyear: {
                        selector: "payone-cc-expire-year",
                        size: "4",
                        maxlength: "4",
                        type: "number"
                    }
                },
                defaultStyle: {
                    input: "height: 100%; width: 100%; border: none; font-size: 17px; border-radius: 0; outline:none !important; box-shadow: none !important;",
                    iframe: {}
                },

                language: Payone.ClientApi.Language.{{language}}
            },
            request: {
                "responsetype":"JSON",
                "encoding":"UTF-8",
                "mode":"{{mode}}",
                "request":"creditcardcheck",
                "storecarddata":"yes",
                "mid":"{{merchantID}}",
                "aid":"{{accountID}}",
                "portalid":"{{portalID}}",
                "hash":"{{hash}}"
            }
        },
    });

    document.querySelector('#submit').addEventListener('click', function (event) {
        event.preventDefault();
        console.log('click!');
        autoCcDetection.performCreditCardCheck();
    });

    autoCcDetection.setInitialCardType("{{supportedCardType}}");
})();
</script>
</body>
</html>