<!doctype html>
<html>
<head>
<title>Payone Credit Card Entry</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta charset="UTF-8">
<style type="text/css">
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
    font-size: 1rem;
    font-weight: 400;
    line-height: 1.5;
    color: #212529;
    text-align: left;
}
form {
    width: auto;
    max-width: 1140px;
    margin: auto;
}
label {
    font-weight: bold;
    display: inline-block;
    margin-bottom: 0.5rem;
}
.form-group {
    margin-bottom: 1rem;
}
.payone-input-mock {
    border: 2px solid #07b;
    border-radius: 10px;
    padding: 5px 15px;
    max-width: 100%;
}
.payone-input-mock iframe {
    height: 50px;
    width: 100%;
    vertical-align: middle;
}
.payone-input-mock input {
    height: 42px;
    width: 90%;
    vertical-align: middle;
    font-size: 17px;
    border: none;
    outline: none;
}
#submit {
    margin: 2rem 0;
    background-color:#07b;
    border-radius: 0.3rem;
    border: none;
    padding: 0.5rem 1rem;
    padding-right: 1rem;
    padding-left: 1rem;
    font-size: 1.25rem;
    line-height: 1.5;
    color:#fff;
    width: 100%;
    font-weight: 400;
    text-align: center;
    vertical-align: middle;
}
input:focus {
  outline: none;
  box-shadow: none;
}
.halves {
    display: flex;
    gap: 1rem;
}
.half {
    flex-grow: 1
}
</style>
<script type="text/javascript">
// intercept console.log
window.console.log = function(msg) {
    snabble.log(msg);
};

// intercept errors
window.onerror = function(msg, url, line, column, error) {
    const message = {
        message: msg,
        url: url,
        line: line,
        column: column,
        error: JSON.stringify(error)
    }

    console.log(message);
};

function showError(msg) {
    snabble.toast(msg)
    snabble.log(msg)
}

window.postMessage = function(a,b) {
    snabble.log(`${a}, ${b}`)
}

function processResponse(response) {
    snabble.log("processResponse for " + response.lastname)
    snabble.saveCard(
        response.pseudocardpan,
        response.truncatedcardpan,
        response.cardtype,
        response.cardexpiredate,
        response.lastname)
}
</script>
<script src="https://secure.pay1.de/client-api/js/v1/payone_hosted.js"></script>
</head>
<body>
<form action="#" method="post">
    <div class="form-group">
        <label for="lastname">{{lastname}}</label>
        <div class="payone-input-mock">
            <input type="text" id="lastname"/>
        </div>
    </div>

    <div class="form-group">
        <label for="payone-cc-pan">{{cardNumberLabel}}</label>
        <div class="payone-input-mock payone-input-mock--pan">
            <!-- Mount element for PAN IFrame. -->
            <span id="payone-cc-pan"></span>
        </div>
    </div>

    <div class="form-group">
        <label for="payone-cc-cvc">{{cvcLabel}}</label>
        <div class="payone-input-mock payone-input-mock--cvc">
            <!-- Mount element for CVC IFrame. -->
            <span id="payone-cc-cvc"></span>
        </div>
    </div>

    <div class="form-group halves">
        <div class="half">
            <label for="payone-cc-expire-month">{{expireMonthLabel}}</label>
            <div class="payone-input-mock payone-input-mock--expire-month">
                <!-- Mount element for card expire month IFrame. -->
                <span id="payone-cc-expire-month"></span>
            </div>
        </div>
        <div class="half">
            <label for="payone-cc-expire-year">{{expireYearLabel}}</label>
            <div class="payone-input-mock payone-input-mock--expire-year">
                <!-- Mount element for card expire year IFrame. -->
                <span id="payone-cc-expire-year"></span>
            </div>
        </div>
    </div>

    <div class="form-group">
        <button id="submit" type="button">{{saveButtonLabel}}</button>
    </div>
</form>
<script type="text/javascript">
function PayoneAutoCcDetection(config) {
    console.log("PayoneAutoCcDetection " + config)
    // Apply config defaults.
    this._config = config;

    // Setup auto credit card detection config.
    console.log("supported types: " + this._config.supportedCardTypes);
    this._config.hostedIframesConfig.config.autoCardtypeDetection = {
        deactivate: false,
        supportedCardtypes: this._config.supportedCardTypes,
        callback: this._handleDetectionResult.bind(this),
    };

    // Create hosted IFrames object.
    this._hostedIframe = new Payone.ClientApi.HostedIFrames(
        this._config.hostedIframesConfig.config,
        this._config.hostedIframesConfig.request
    );

    // Register credit card check callback.
    // The hosted IFrames API expects a callback provided as string,
    // therefore we cannot use a function value reference directly.
    // As a workaround we register the actual handler method as global
    // function with a random unique name which will be provided to the
    // hosted IFrames API later.
    this._creditCardCheckCallbackName = 'payone_cc_check_callback_' + Math.random().toString().substr(2);
    window[this._creditCardCheckCallbackName] = this._creditCardCheckCallback.bind(this);
}

PayoneAutoCcDetection.prototype._handleDetectionResult = function (type) {
    console.log("handleDetection " + type);
    type = type.toUpperCase();

    // Delegate further processing to dedicated handlers.
    switch (type) {
        case '?':
            this._handleUnknownCardType(type);
            break;
        case '-':
            this._handleUnsupportedCardType(type);
            break;
        default:
            this._handleValidCardType(type);
            break;
    }
}

PayoneAutoCcDetection.prototype._handleValidCardType = function (type) {
    console.log("handleValidCard " + type);
    this._changeIcon(type);
}


PayoneAutoCcDetection.prototype._handleUnsupportedCardType = function () {
    console.log("handleUnsupportedType");
}

PayoneAutoCcDetection.prototype._creditCardCheckCallback = function (response) {
    switch (response.status) {
        case 'VALID':
            console.log('Success! Credit card check was valid.');
            var lastname = document.getElementById('lastname').value;
            processResponse({
                pseudocardpan: response.pseudocardpan,
                truncatedcardpan: response.truncatedcardpan,
                cardtype: response.cardtype,
                cardexpiredate: response.cardexpiredate,
                lastname
            });
            break;
        case 'INVALID':
        case 'ERROR':
            showError('Error ' + response.errorcode + ': ' + response.errormessage);
            break;
        default:
            showError('API returned an unexpected status.');
            break;
    }
}

PayoneAutoCcDetection.prototype.performCreditCardCheck = function () {
    console.log("performCheck");
    var name = document.getElementById('lastname').value
    if (this._hostedIframe.isComplete() && name != "") {
        console.log("complete!");
        this._hostedIframe.creditCardCheck(this._creditCardCheckCallbackName);
    }
    else {
        console.log("incomplete :(");
        showError('{{incompleteForm}}');
    }
}

PayoneAutoCcDetection.prototype.setInitialCardType = function (type) {
    console.log("set initial card type " + type)
    this._hostedIframe.setCardType(type)
}

var autoCcDetection = new PayoneAutoCcDetection({
    supportedCardTypes: ["{{supportedCardType}}"],
    hostedIframesConfig: {
        config: {
            fields: {
                cardpan: {
                    selector: "payone-cc-pan",
                    type: "number"
                },
                cardcvc2: {
                    selector: "payone-cc-cvc",
                    type: "password",
                    size: "4",
                    maxlength: "4",
                    length: { "V": 3, "M": 3, "A": 4 }
                },
                cardexpiremonth: {
                    selector: "payone-cc-expire-month",
                    type: "number",
                    size: "2",
                    maxlength: "2"
                },
                cardexpireyear: {
                    selector: "payone-cc-expire-year",
                    size: "4",
                    maxlength: "4",
                    type: "number"
                }
            },
            defaultStyle: {
                input: "height: 100%; width: 100%; border: none; font-size: 17px; border-radius: 0; outline:none !important; box-shadow: none !important;",
                iframe: {}
            },

            language: Payone.ClientApi.Language.{{language}}
        },
        request: {
            "responsetype":"JSON",
            "encoding":"UTF-8",
            "mode":"{{mode}}",
            "request":"creditcardcheck",
            "storecarddata":"yes",
            "mid":"{{merchantID}}",
            "aid":"{{accountID}}",
            "portalid":"{{portalID}}",
            "hash":"{{hash}}"
        }
    },
});

document.querySelector('#submit').addEventListener('click', function (event) {
    event.preventDefault();
    console.log('click!');
    autoCcDetection.performCreditCardCheck();
});

autoCcDetection.setInitialCardType("{{supportedCardType}}");
</script>
</body>
</html>